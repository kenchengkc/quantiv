"use strict";(()=>{var e={};e.id=137,e.ids=[137],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},5330:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>g,patchFetch:()=>R,requestAsyncStorage:()=>y,routeModule:()=>h,serverHooks:()=>x,staticGenerationAsyncStorage:()=>v});var a={};i.r(a),i.d(a,{GET:()=>d,OPTIONS:()=>u});var s=i(9303),o=i(8716),r=i(670),n=i(7070),p=i(5074),c=i(7107),l=i(6120);class m{static async getChain(e,t){await new Promise(e=>setTimeout(e,100));let i=150+50*Math.random(),a=t||"2024-02-16",s=Math.max(1,Math.ceil((new Date(a).getTime()-Date.now())/864e5)),o=[],r=5*Math.round(i/5);for(let e=-10;e<=10;e++)o.push(r+5*e);let n=o.map(e=>({strike:e,mid:Math.max(.01,i-e+5*Math.random()),bid:0,ask:0,iv:.2+.3*Math.random(),volume:Math.floor(1e3*Math.random()),openInterest:Math.floor(5e3*Math.random())}));n.forEach(e=>{let t=Math.max(.01,.05*e.mid);e.bid=Math.max(.01,e.mid-t/2),e.ask=e.mid+t/2});let p=o.map(e=>({strike:e,mid:Math.max(.01,e-i+5*Math.random()),bid:0,ask:0,iv:.2+.3*Math.random(),volume:Math.floor(1e3*Math.random()),openInterest:Math.floor(5e3*Math.random())}));return p.forEach(e=>{let t=Math.max(.01,.05*e.mid);e.bid=Math.max(.01,e.mid-t/2),e.ask=e.mid+t/2}),{symbol:e.toUpperCase(),spot:i,expiryDate:a,daysToExpiry:s,strikes:o,calls:n,puts:p,timestamp:new Date().toISOString()}}}async function d(e){let t=Date.now();try{let i=new URL(e.url),a={symbol:i.searchParams.get("symbol"),expiry:i.searchParams.get("expiry")},s=(0,p.Gl)(p.rJ,a);if(!s.success)return n.NextResponse.json((0,p.ql)(void 0,"Invalid request parameters",s.details?.join(", ")),{status:400});let{symbol:o,expiry:r}=s.data,d=c.ZU.optionsChain(o,r||"default"),u=c.Oj.optionsChain.get(d),h="l1";if(!u){let e=l.R8.optionsChain(o,r||"default");h=(u=await l.ES.getJson(e))?"l2":"miss",u?c.Oj.optionsChain.set(d,u,6e4):(u=await m.getChain(o,r),c.Oj.optionsChain.set(d,u,6e4),await l.ES.setJson(e,u,300),h="miss")}let y=function(e,t){if(0===e.length)throw Error("No strikes provided");return e.reduce((e,i)=>Math.abs(i-t)<Math.abs(e-t)?i:e)}(u.spot,u.strikes),v=u.calls.find(e=>e.strike===y),x=u.puts.find(e=>e.strike===y);if(!v||!x)return n.NextResponse.json((0,p.ql)(void 0,"ATM options not found","Unable to find call and put at ATM strike"),{status:500});let g=u.daysToExpiry/365,R={spot:u.spot,expiryUsed:u.expiryDate,atm:{strike:y,callMid:v.mid,putMid:x.mid,iv:v.iv||x.iv||.25,T:g},rows:u.strikes.map(e=>{let t=u.calls.find(t=>t.strike===e),i=u.puts.find(t=>t.strike===e);return{strike:e,call:t||{strike:e,mid:0,bid:0,ask:0,iv:.25,volume:0,openInterest:0},put:i||{strike:e,mid:0,bid:0,ask:0,iv:.25,volume:0,openInterest:0}}})},w=(0,p.ql)(R),S=Date.now()-t,f=new Headers({"Content-Type":"application/json","Cache-Control":"public, s-maxage=60, stale-while-revalidate=300","X-Cache-Hit":h,"X-Processing-Time":`${S}ms`,"X-Symbol":o,"X-Expiry":u.expiryDate});return n.NextResponse.json(w,{headers:f})}catch(t){console.error("[API] /api/options error:",t);let e=(0,p.ql)(void 0,"Internal server error",t instanceof Error?t.message:"Unknown error","Please try again or contact support if the issue persists");return n.NextResponse.json(e,{status:500})}}async function u(){return new n.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}let h=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/options/route",pathname:"/api/options",filename:"route",bundlePath:"app/api/options/route"},resolvedPagePath:"/Users/ken/Desktop/quantiv/app/api/options/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:v,serverHooks:x}=h,g="/api/options/route";function R(){return(0,r.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:v})}},7107:(e,t,i)=>{i.d(t,{MJ:()=>r,Oj:()=>o,ZU:()=>n});var a=i(138);class s{constructor(e,t={}){this.hits=0,this.misses=0,this.name=e,this.cache=new a.z({max:t.maxSize||100,ttl:t.ttlMs||6e4,updateAgeOnGet:t.updateAgeOnGet??!0,dispose:(e,t)=>{console.debug(`[${this.name}] Evicted cache entry: ${t}`)}})}get(e){let t=this.cache.get(e);return t?(this.hits++,t.data):(this.misses++,null)}set(e,t,i){let a={data:t,timestamp:Date.now(),key:e};i?this.cache.set(e,a,{ttl:i}):this.cache.set(e,a)}has(e){return this.cache.has(e)}delete(e){return this.cache.delete(e)}clear(){this.cache.clear(),this.hits=0,this.misses=0}getStats(){let e=this.hits+this.misses;return{name:this.name,size:this.cache.size,maxSize:this.cache.max,hits:this.hits,misses:this.misses,hitRate:e>0?this.hits/e*100:0,calculatedSize:this.cache.calculatedSize||0}}async getOrSet(e,t,i){let a=this.get(e);if(null!==a)return a;try{let a=await t();return this.set(e,a,i),a}catch(t){throw console.error(`[${this.name}] Error fetching data for key ${e}:`,t),t}}peek(e){let t=this.cache.peek(e);return t?t.data:null}keys(){return Array.from(this.cache.keys())}getInfo(){let e=[],t=Date.now();for(let[i,a]of Array.from(this.cache.entries()))e.push({key:i,timestamp:a.timestamp,age:t-a.timestamp});return{name:this.name,entries:e,stats:this.getStats()}}}let o={optionsChain:new s("options-chain",{maxSize:200,ttlMs:6e4,updateAgeOnGet:!0}),expectedMove:new s("expected-move",{maxSize:150,ttlMs:9e4,updateAgeOnGet:!0}),earnings:new s("earnings",{maxSize:100,ttlMs:3e5,updateAgeOnGet:!0}),priceHistory:new s("price-history",{maxSize:50,ttlMs:6e5,updateAgeOnGet:!1}),ivSeries:new s("iv-series",{maxSize:100,ttlMs:18e5,updateAgeOnGet:!1})};function r(){return{optionsChain:o.optionsChain.getStats(),expectedMove:o.expectedMove.getStats(),earnings:o.earnings.getStats(),priceHistory:o.priceHistory.getStats(),ivSeries:o.ivSeries.getStats()}}let n={optionsChain:(e,t)=>`${e.toUpperCase()}:${t}`,expectedMove:(e,t)=>`${e.toUpperCase()}:${t}`,earnings:e=>e.toUpperCase(),priceHistory:(e,t)=>`${e.toUpperCase()}:${t}d`,ivSeries:(e,t)=>`${e.toUpperCase()}:${t}d`}},6120:(e,t,i)=>{i.d(t,{ES:()=>o,O4:()=>r,R8:()=>s,pb:()=>n});let a=new(i(6859)).s({url:process.env.REDIS_URL,token:process.env.REDIS_TOKEN}),s={expectedMoveSnapshot:(e,t)=>`em:snap:${e.toUpperCase()}:${t}`,topMovers:e=>`em:top:${e}`,ivSeries:e=>`iv:series:${e.toUpperCase()}`,dailyVisits:e=>`d:visits:${e}`,optionsChain:(e,t)=>`chain:${e.toUpperCase()}:${t}`,earnings:e=>`earnings:${e.toUpperCase()}`,priceHistory:e=>`prices:${e.toUpperCase()}`};class o{static async setJson(e,t,i=120){try{await a.setex(e,i,JSON.stringify(t))}catch(t){console.error(`Redis setJson error for key ${e}:`,t)}}static async getJson(e){try{let t=await a.get(e);return t?JSON.parse(t):null}catch(t){return console.error(`Redis getJson error for key ${e}:`,t),null}}static async increment(e,t){try{let i=await a.incr(e);return t&&1===i&&await a.expire(e,t),i}catch(t){return console.error(`Redis increment error for key ${e}:`,t),0}}static async addToSortedSet(e,t,i,s){try{await a.zadd(e,{score:t,member:i}),s&&await a.expire(e,s)}catch(t){console.error(`Redis zadd error for key ${e}:`,t)}}static async getTopFromSortedSet(e,t=10){try{let i=await a.zrange(e,0,t-1,{rev:!0,withScores:!0}),s=[];for(let e=0;e<i.length;e+=2)s.push({member:i[e],score:i[e+1]});return s}catch(t){return console.error(`Redis zrange error for key ${e}:`,t),[]}}static async delete(e){try{await a.del(e)}catch(t){console.error(`Redis delete error for key ${e}:`,t)}}static async exists(e){try{let t=await a.exists(e);return 1===t}catch(t){return console.error(`Redis exists error for key ${e}:`,t),!1}}static async getTTL(e){try{return await a.ttl(e)}catch(t){return console.error(`Redis TTL error for key ${e}:`,t),-1}}}class r{static async cacheExpectedMove(e,t,i,a=120){let r=s.expectedMoveSnapshot(e,t),n={...i,timestamp:new Date().toISOString(),symbol:e.toUpperCase(),expiry:t};await o.setJson(r,n,a)}static async getExpectedMove(e,t){let i=s.expectedMoveSnapshot(e,t);return await o.getJson(i)}static async incrementVisitorCount(){let e=new Date().toISOString().split("T")[0].replace(/-/g,""),t=s.dailyVisits(e);return await o.increment(t,172800)}static async getVisitorCount(e){let t=e||new Date().toISOString().split("T")[0].replace(/-/g,""),i=s.dailyVisits(t);try{let e=await a.get(i);return e?parseInt(e,10):0}catch(e){return console.error(`Error getting visitor count for ${t}:`,e),0}}static async cacheIVSeries(e,t,i=86400){let a=s.ivSeries(e);await o.setJson(a,t,i)}static async getIVSeries(e){let t=s.ivSeries(e);return await o.getJson(t)}static async addTopMover(e,t,i){let a=i||new Date().toISOString().split("T")[0].replace(/-/g,""),r=s.topMovers(a);await o.addToSortedSet(r,t,e.toUpperCase(),86400)}static async getTopMovers(e,t=10){let i=e||new Date().toISOString().split("T")[0].replace(/-/g,""),a=s.topMovers(i);return(await o.getTopFromSortedSet(a,t)).map(e=>({symbol:e.member,expectedMovePct:e.score}))}}async function n(){try{let e=Date.now();await a.ping();let t=Date.now()-e;return{connected:!0,latency:t}}catch(e){return{connected:!1,error:e instanceof Error?e.message:"Unknown error"}}}},5074:(e,t,i)=>{i.d(t,{Gl:()=>x,Qp:()=>y,ql:()=>g,rJ:()=>h,z1:()=>v});var a=i(1585),s=i(6033);let o=a.Z_().min(1,"Symbol is required").max(10,"Symbol too long").regex(/^[A-Za-z0-9.-]+$/,"Invalid symbol format").transform(e=>e.toUpperCase()),r=a.Z_().regex(/^\d{4}-\d{2}-\d{2}$/,"Expiry must be in YYYY-MM-DD format").refine(e=>new Date(e)>new Date,"Expiry must be in the future"),n=a.Z_().regex(/^\d{4}-\d{2}-\d{2}$/,"Date must be in YYYY-MM-DD format"),p=a.Ry({strike:a.Rx().positive("Strike must be positive"),mid:a.Rx().nonnegative("Mid price cannot be negative"),bid:a.Rx().nonnegative("Bid price cannot be negative"),ask:a.Rx().nonnegative("Ask price cannot be negative"),iv:a.Rx().positive("IV must be positive").optional(),delta:a.Rx().optional(),gamma:a.Rx().optional(),theta:a.Rx().optional(),vega:a.Rx().optional(),rho:a.Rx().optional(),volume:a.Rx().nonnegative().optional(),openInterest:a.Rx().nonnegative().optional(),lastPrice:a.Rx().nonnegative().optional(),change:a.Rx().optional(),changePct:a.Rx().optional()});a.Ry({symbol:o,spot:a.Rx().positive("Spot price must be positive"),expiryDate:r,daysToExpiry:a.Rx().positive("Days to expiry must be positive"),strikes:a.IX(a.Rx().positive()).min(1,"At least one strike required"),calls:a.IX(p).min(1,"At least one call required"),puts:a.IX(p).min(1,"At least one put required"),timestamp:a.Z_().datetime().optional(),source:a.Z_().optional()});let c=a.Ry({straddle:a.Ry({abs:a.Rx().nonnegative("Straddle move cannot be negative"),pct:a.Rx().nonnegative("Straddle percentage cannot be negative")}),iv:a.Ry({abs:a.Rx().nonnegative("IV move cannot be negative"),pct:a.Rx().nonnegative("IV percentage cannot be negative")}),bands:a.Ry({oneSigma:a.Ry({upper:a.Rx(),lower:a.Rx()}),twoSigma:a.Ry({upper:a.Rx(),lower:a.Rx()})}),confidence:a.Ry({straddle:a.Km(["high","medium","low"]),iv:a.Km(["high","medium","low"])})}),l=a.Ry({rank:a.Rx().min(0).max(1,"IV rank must be between 0 and 1"),percentile:a.Rx().min(0).max(100,"Percentile must be between 0 and 100"),current:a.Rx().positive("Current IV must be positive"),min:a.Rx().positive("Min IV must be positive"),max:a.Rx().positive("Max IV must be positive"),mean:a.Rx().positive("Mean IV must be positive"),median:a.Rx().positive("Median IV must be positive"),stdDev:a.Rx().nonnegative("Standard deviation cannot be negative"),daysInSample:a.Rx().positive("Days in sample must be positive")}),m=a.Ry({date:n,confidence:a.Km(["confirmed","estimated"]),timing:a.Km(["bmo","amc","unknown"]).optional(),estimate:a.Ry({eps:a.Rx().optional(),revenue:a.Rx().optional()}).optional()}),d=a.Ry({date:n,realizedMovePct:a.Rx(),priceChange:a.Rx(),priceBefore:a.Rx().positive(),priceAfter:a.Rx().positive(),volume:a.Rx().nonnegative().optional()}),u=a.Ry({symbol:o,next:m.optional(),last:a.IX(d).max(8,"Maximum 8 historical earnings"),timestamp:a.Z_().datetime().optional()}),h=a.Ry({symbol:o,expiry:r.optional()}),y=a.Ry({symbol:o,expiry:r.optional()}),v=a.Ry({symbol:o});function x(e,t){try{let i=e.parse(t);return{success:!0,data:i}}catch(e){if(e instanceof s.jm)return{success:!1,error:"Validation failed",details:e.errors.map(e=>`${e.path.join(".")}: ${e.message}`)};return{success:!1,error:"Unknown validation error",details:[e instanceof Error?e.message:"Unknown error"]}}}function g(e,t,i,a){return{success:!t,...e&&{data:e},...t&&{error:t},...i&&{detail:i},...a&&{hint:a},timestamp:new Date().toISOString()}}a.Ry({date:n.optional(),limit:a.Rx().min(1).max(50).default(10)}),a.Ry({success:a.O7(),data:a.Ry({spot:a.Rx().positive(),expiryUsed:r,atm:a.Ry({strike:a.Rx().positive(),callMid:a.Rx().nonnegative(),putMid:a.Rx().nonnegative(),iv:a.Rx().positive(),T:a.Rx().positive()}),rows:a.IX(a.Ry({strike:a.Rx().positive(),call:p,put:p}))}).optional(),error:a.Z_().optional(),timestamp:a.Z_().datetime()}),a.Ry({success:a.O7(),data:a.Ry({em:c,ivRank:l}).optional(),error:a.Z_().optional(),timestamp:a.Z_().datetime()}),a.Ry({success:a.O7(),data:u.optional(),error:a.Z_().optional(),timestamp:a.Z_().datetime()}),a.Ry({success:a.O7(),data:a.Ry({count:a.Rx().nonnegative()}).optional(),error:a.Z_().optional(),timestamp:a.Z_().datetime()}),a.Ry({success:a.O7(),data:a.IX(a.Ry({symbol:o,expectedMovePct:a.Rx().nonnegative(),spot:a.Rx().positive().optional(),volume:a.Rx().nonnegative().optional()})).optional(),error:a.Z_().optional(),timestamp:a.Z_().datetime()}),a.Ry({success:a.i0(!1),error:a.Z_(),detail:a.Z_().optional(),hint:a.Z_().optional(),timestamp:a.Z_().datetime()}),a.Ry({status:a.Km(["healthy","degraded","unhealthy"]),timestamp:a.Z_().datetime(),services:a.Ry({redis:a.Ry({connected:a.O7(),latency:a.Rx().optional(),error:a.Z_().optional()}),cache:a.Ry({l1Stats:a.IM(a.Ry({size:a.Rx(),hitRate:a.Rx()}))})}),version:a.Z_().optional()})}};var t=require("../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),a=t.X(0,[276,982,585,138],()=>i(5330));module.exports=a})();